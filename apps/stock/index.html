<!-- PATH: /apps/stock/index.html -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0f1a" />
  <title>Stock v√©hicule ‚Äî Ap√©ro de Nuit 66</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon-192.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./icon-192.svg" />

  <style>
    :root{
      --bg:#060a12;
      --card:#0b1220;
      --card2:#0f1a2d;
      --text:#e8f0ff;
      --muted:#9fb3d1;
      --line:rgba(255,255,255,.08);
      --accent:#ffd54a;
      --danger:#ff3b3b;
      --ok:#31d158;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --r:18px;
      --btn:rgba(255,255,255,.07);
      --btn2:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 600px at 50% -120px, rgba(255,213,74,.16), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(73,136,255,.12), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(6,10,18,.92), rgba(6,10,18,.62));
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:14px 14px 10px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,213,74,.30), rgba(255,213,74,.06));
      border:1px solid rgba(255,213,74,.24);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .logo svg{ opacity:.95 }
    .title{
      min-width:0;
    }
    .title h1{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title p{
      margin:3px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topRight{
      display:flex; align-items:center; gap:10px;
    }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .pill b{ color:var(--text); font-weight:700; }
    .btnIcon{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .btnIcon:active{ transform: translateY(1px); }

    main{ padding:14px 14px 26px; }
    .grid{
      max-width:980px; margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .cardHeader p{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .cardBody{ padding:12px 14px 14px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .search{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1 1 320px;
      min-width:240px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ background: var(--btn2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(255,213,74,.34);
      background: rgba(255,213,74,.10);
    }
    .btn.danger{
      border-color: rgba(255,59,59,.35);
      background: rgba(255,59,59,.10);
      color: #ffecec;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns: 66px 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .thumb{
      width:66px; height:66px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:6px;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    .meta{
      min-width:0;
    }
    .meta .name{
      font-size:14px;
      font-weight:700;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .desc{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qty{
      width:70px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:14px;
      text-align:center;
      outline:none;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      user-select:none;
    }
    .badge.ok{ border-color: rgba(49,209,88,.35); background: rgba(49,209,88,.10); color:#dfffe8; }
    .badge.warn{ border-color: rgba(255,213,74,.35); background: rgba(255,213,74,.10); color:#fff4cf; }
    .badge.danger{ border-color: rgba(255,59,59,.35); background: rgba(255,59,59,.10); color:#ffe3e3; }

    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,24,.92);
      color:var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:99;
      max-width: calc(100% - 18px);
      text-align:center;
      font-size:13px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .sheet{
      position:fixed;
      inset:0;
      display:none;
      z-index:50;
    }
    .sheet.show{ display:block; }
    .sheet .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .sheet .panel{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(520px, calc(100% - 22px));
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(12,18,32,.98), rgba(8,12,22,.98));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheet .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .sheet .panelHeader button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }
    .sheet .panelBody{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .hint{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .panelActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding:14px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2c5.3 0 9.6 4.3 9.6 9.6S17.3 21.2 12 21.2 2.4 16.9 2.4 11.6 6.7 2 12 2Z" stroke="rgba(255,213,74,.9)" stroke-width="1.4"/>
            <path d="M7.2 12.4c1.4 2.2 3 3.2 4.8 3.2s3.4-1 4.8-3.2" stroke="rgba(255,213,74,.9)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M9.1 9.7h.01M14.9 9.7h.01" stroke="rgba(255,213,74,.9)" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>Stock v√©hicule</h1>
          <p>Synchronis√© avec l‚Äôoutil interne ‚Äî Ap√©ro de Nuit 66</p>
        </div>
      </div>

      <div class="topRight">
        <div class="pill" id="syncPill" title="Derni√®re synchronisation">
          <span>Sync</span> <b id="syncText">‚Äî</b>
        </div>
        <button class="btnIcon" id="btnOpenSettings" title="Outils">‚ò∞</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="cardHeader">
        <div>
          <h2>Stock en direct : synchronis√© avec le v√©hicule</h2>
          <p>Affichage indicatif (mise √† jour ~3 minutes). Un produit peut √™tre temporairement indisponible.</p>
        </div>
        <span class="badge" id="dirtyBadge">OK</span>
      </div>

      <div class="cardBody">
        <div class="toolbar">
          <div class="search">
            <span style="opacity:.7">üîé</span>
            <input id="q" type="search" placeholder="Rechercher un produit‚Ä¶" autocomplete="off" />
          </div>

          <div class="actions">
            <button class="btn" id="btnReload" title="Recharger depuis GitHub (public)">‚ü≤ Recharger</button>
            <button class="btn primary" id="btnSaveRepo" title="Publier via Cloudflare (PIN)">Publier</button>
            <button class="btn danger" id="btnReset" title="Annuler les modifications locales">Annuler</button>
          </div>
        </div>

        <div class="list" id="list"></div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- SETTINGS SHEET -->
<div class="sheet" id="sheet">
  <div class="backdrop" id="sheetBackdrop"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="panelHeader">
      <h3 id="settingsTitle">Outils</h3>
      <button id="sheetClose" aria-label="Fermer">‚úï</button>
    </div>

    <div class="panelBody">
      <div class="field">
        <label>Branch</label>
        <input id="ghBranch" value="main" readonly />
      </div>

      <div class="field">
        <label>Chemin du fichier</label>
        <input id="ghPath" value="apps/stock/stock/_snapshot.json" readonly />
      </div>

      <div class="field">
        <label>Code admin (PIN)</label>
        <input id="tokenInput" type="password" placeholder="0000" inputmode="numeric" />
      </div>

      <p class="hint" id="tokenHint">
        Stock√© en local sur ce t√©l√©phone (6 mois).
        <span id="tokenState"></span>
      </p>
    </div>

    <div class="panelActions">
      <button class="btn" id="btnSaveToken">Enregistrer le code</button>
      <button class="btn danger" id="btnClearToken">Supprimer le code</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
   ========================= */

// IMPORTANT: les images produits ne sont plus dans /img/,
// elles sont maintenant dans /apps/stock/stock/*.png
const IMG_DIR = "./stock/";

const DEFAULT_GH = {
  owner: "bullyto",
  repo: "outil",
  branch: "main",
  stockPath: "apps/stock/stock",
  ext: ".json"
};

// Cloudflare Worker (m√™me Worker que stats)
const WORKER_BASE = "https://quiet-sunset-9161.apero-nuit-du-66.workers.dev";

/* =========================
   DATA (produits)
   ========================= */

const PRODUCTS = [
  { id:"absolut", name:"Absolut", desc:"Vodka", img:"absolut.png" },
  { id:"ballantines", name:"Ballantine's", desc:"Whisky", img:"ballantines.png" },
  { id:"captain_morgan", name:"Captain Morgan", desc:"Rhum", img:"captain_morgan.png" },
  { id:"cacahuette", name:"Cacahu√®tes", desc:"Snacking", img:"cacahuette.png" },
  { id:"bretzel", name:"Bretzels", desc:"Snacking", img:"bretzel.png" },
  { id:"TROIS_RIVIERES", name:"Trois Rivi√®res", desc:"Rhum", img:"TROIS_RIVIERES.png" },
];

// alias (au cas o√π)
const ID_ALIASES = {
  "trois_rivieres": "TROIS_RIVIERES",
  "TROIS_RIVIERES": "TROIS_RIVIERES"
};

function $(sel){ return document.querySelector(sel); }
function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

const listEl = $("#list");
const qEl = $("#q");
const btnReload = $("#btnReload");
const btnSaveRepo = $("#btnSaveRepo");
const btnReset = $("#btnReset");
const dirtyBadge = $("#dirtyBadge");
const syncText = $("#syncText");

// sheet
const sheet = $("#sheet");
const sheetBackdrop = $("#sheetBackdrop");
const sheetClose = $("#sheetClose");
const btnOpenSettings = $("#btnOpenSettings");
const tokenInput = $("#tokenInput");
const tokenState = $("#tokenState");
const tokenHint = $("#tokenHint");
const btnSaveToken = $("#btnSaveToken");
const btnClearToken = $("#btnClearToken");

// local storage
const SETTINGS_KEY = "adn66_stock_settings_v2";

const state = {
  pin: "",
  // (legacy) token: "",
  stock: {},           // id -> qty
  dirty: new Set(),    // ids modified
  lastSync: null
};

function toastMsg(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toast);
  window.__toast = setTimeout(()=> t.classList.remove("show"), 2200);
}

function getGH(){
  return {
    owner: DEFAULT_GH.owner,
    repo: DEFAULT_GH.repo,
    branch: DEFAULT_GH.branch,
    stockPath: DEFAULT_GH.stockPath,
    ext: DEFAULT_GH.ext,
    pin: String(state.pin||"").trim()
  };
}

function fileForId(id){
  const gh = getGH();
  return `${gh.stockPath}/${id}${gh.ext}`;
}
function snapshotPath(){
  const gh = getGH();
  return `${gh.stockPath}/_snapshot.json`;
}

function openSettings(){
  sheet.classList.add("show");
  tokenInput.value = state.pin || "";
  updateTokenHint();
}
function closeSettings(){
  sheet.classList.remove("show");
}

function updateTokenHint(){
  if(state.pin){
    tokenState.textContent = "Code enregistr√© ‚úÖ";
  }else{
    tokenState.textContent = "";
  }
}

function saveToken(pin){
  // On garde le nom historique "saveToken" pour ne rien casser,
  // mais on enregistre maintenant un PIN (ex: 0000) au lieu d'un token GitHub.
  const exp = Date.now() + (1000 * 60 * 60 * 24 * 30 * 6); // ~6 mois
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({ v: 3, pin: String(pin||"").trim(), exp }));
  state.pin = String(pin||"").trim();
  updateSaveButtonsState();
}

function clearToken(){
  localStorage.removeItem(SETTINGS_KEY);
  state.pin = "";
  updateSaveButtonsState();
}

function loadSettings(){
  const raw = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  if (raw.exp && Date.now() > raw.exp) {
    localStorage.removeItem(SETTINGS_KEY);
  }
  // AVANT: token GitHub (PAT) ; MAINTENANT: PIN admin (ex: 0000)
  state.pin = String(raw.pin ?? raw.token ?? "").trim();
}

function updateSaveButtonsState(){
  const s = getGH();
  const hasPin = !!String(s.pin||"").trim();
  // on autorise la publication uniquement si un PIN est pr√©sent
  btnSaveRepo.disabled = !hasPin;
}

function updateDirtyBadge(){
  const n = state.dirty.size;
  if(n === 0){
    dirtyBadge.textContent = "OK";
    dirtyBadge.className = "badge ok";
  }else{
    dirtyBadge.textContent = `${n} modif.`;
    dirtyBadge.className = "badge warn";
  }
}

function setSync(ts){
  state.lastSync = ts;
  syncText.textContent = ts ? new Date(ts).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}) : "‚Äî";
}

function clampQty(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return 0;
  return Math.max(0, Math.min(999, Math.round(n)));
}

function renderList(){
  const q = (qEl.value || "").trim().toLowerCase();

  const rows = PRODUCTS
    .filter(p => !q || p.name.toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q))
    .map(p => {
      const id = ID_ALIASES[p.id] || p.id;
      const qty = Number(state.stock[id] ?? 0);
      const isDirty = state.dirty.has(id);
      const badgeCls = qty > 0 ? "ok" : "danger";
      const badgeTxt = qty > 0 ? "Dispo" : "Rupture";
      return `
        <div class="item" data-id="${esc(id)}">
          <div class="thumb"><img src="${esc(IMG_DIR + p.img)}" alt="${esc(p.name)}" loading="lazy" /></div>
          <div class="meta">
            <p class="name">${esc(p.name)}</p>
            <p class="desc">${esc(p.desc||"")}</p>
            <span class="badge ${badgeCls}">${badgeTxt}${isDirty ? " ‚Ä¢ modifi√©" : ""}</span>
          </div>
          <div class="qtyBox">
            <input class="qty" type="number" inputmode="numeric" min="0" max="999" value="${esc(qty)}" />
          </div>
        </div>
      `;
    })
    .join("");

  listEl.innerHTML = rows || `<div class="badge" style="padding:12px 14px;border-radius:16px;">Aucun r√©sultat</div>`;

  // bind inputs
  listEl.querySelectorAll(".item").forEach(el => {
    const id = el.getAttribute("data-id");
    const input = el.querySelector(".qty");
    input.addEventListener("change", ()=>{
      const v = clampQty(input.value);
      input.value = v;
      state.stock[id] = v;
      state.dirty.add(id);
      updateDirtyBadge();
    });
  });

  updateDirtyBadge();
}

function updateStockUI(){
  renderList();
  updateSaveButtonsState();
}

/* =========================
   LOAD FROM REPO (public raw)
   ========================= */

async function pullFromRepo(){
  const s = getGH();
  toastMsg("Chargement d√©p√¥t‚Ä¶");

  const snapFile = snapshotPath();
  let snap = null;

  try{
    const rawUrl = `https://raw.githubusercontent.com/${s.owner}/${s.repo}/${s.branch}/${snapFile}?t=${Date.now()}`;
    const res = await fetch(rawUrl, { cache:"no-store" });
    if(res.ok) snap = await res.json();
  }catch(e){
    console.warn("pullFromRepo snapshot failed", e);
  }

  if(snap && Array.isArray(snap.items)){
    for(const it of snap.items){
      if(!it || !it.id) continue;
      const id = ID_ALIASES[it.id] || it.id;
      if(typeof it.qty === "number") state.stock[id] = it.qty;
    }
  }

  updateStockUI();
  toastMsg("Charg√© ‚úÖ");
}

/* =========================
   PUBLISH VIA WORKER (PIN)
   ========================= */

async function pushToRepo(){
  const s = getGH();
  const pin = String(s.pin||"").trim();

  if(!pin){
    toastMsg("Entre le code admin (0000).");
    openSettings();
    return;
  }

  // on garde un contr√¥le c√¥t√© client (le serveur re-valide)
  if(pin !== "0000"){
    toastMsg("Code invalide.");
    return;
  }

  toastMsg("Publication via Cloudflare‚Ä¶");

  // Pr√©parer payload (m√™me logique qu‚Äôavant, mais l‚Äô√©criture GitHub se fait c√¥t√© Worker)
  const idsToPush = Object.keys(state.stock).filter(id => state.dirty.has(id));
  const payload = {
    pin,
    owner: s.owner,
    repo: s.repo,
    branch: s.branch,
    stockPath: s.stockPath,
    ext: s.ext,
    ids: idsToPush,
    stock: state.stock,
    updated_at: new Date().toISOString()
  };

  const r = await fetch(`${WORKER_BASE}/api/stock/publish`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await r.text();
  let j = null;
  try{ j = JSON.parse(txt); }catch(e){ j = null; }

  if(!r.ok || !j || j.ok !== true){
    const msg = (j && j.error) ? String(j.error) : `HTTP ${r.status}`;
    throw new Error(msg);
  }

  // Success
  idsToPush.forEach(id => state.dirty.delete(id));
  updateStockUI();

  toastMsg("Publi√© ‚úÖ");
}

/* =========================
   UI EVENTS
   ========================= */

btnOpenSettings.addEventListener("click", openSettings);
sheetBackdrop.addEventListener("click", closeSettings);
sheetClose.addEventListener("click", closeSettings);

btnSaveToken.addEventListener("click", ()=>{
  const pin = String(tokenInput.value||"").trim();
  if(!pin){ toastMsg("Code vide."); return; }
  saveToken(pin);
  updateTokenHint();
  toastMsg("Code enregistr√© ‚úÖ");
});

btnClearToken.addEventListener("click", ()=>{
  clearToken();
  tokenInput.value = "";
  updateTokenHint();
  toastMsg("Code supprim√©.");
});

btnReload.addEventListener("click", async ()=>{
  try{
    await pullFromRepo();
    setSync(Date.now());
  }catch(e){
    console.error(e);
    toastMsg("Erreur rechargement.");
  }
});

btnSaveRepo.addEventListener("click", async ()=>{
  try{
    await pushToRepo();
    setSync(Date.now());
  }catch(e){
    console.error(e);
    toastMsg("Erreur : " + (e?.message || e));
  }
});

btnReset.addEventListener("click", ()=>{
  // annule les modifications locales (recharge)
  state.dirty.clear();
  pullFromRepo().then(()=>toastMsg("Annul√© ‚úÖ")).catch(()=>toastMsg("Erreur annulation."));
});

qEl.addEventListener("input", renderList);

/* =========================
   INIT
   ========================= */

(async function init(){
  loadSettings();
  updateTokenHint();
  updateSaveButtonsState();
  await pullFromRepo();
  setSync(Date.now());

  // SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
