<!-- PATH: /apps/stock/index.html -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0f1a" />
  <title>Stock vÃ©hicule â€” ApÃ©ro de Nuit 66</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon-192.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./icon-192.svg" />

  <style>
    :root{
      --bg:#060a12;
      --card:#0b1220;
      --card2:#0f1a2d;
      --text:#e8f0ff;
      --muted:#9fb3d1;
      --line:rgba(255,255,255,.08);
      --accent:#ffd54a;
      --danger:#ff3b3b;
      --ok:#31d158;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --r:18px;
      --btn:rgba(255,255,255,.07);
      --btn2:rgba(255,255,255,.10);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 600px at 50% -120px, rgba(255,213,74,.16), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(73,136,255,.12), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(6,10,18,.92), rgba(6,10,18,.62));
      border-bottom:1px solid var(--line);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:14px 14px 10px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 0; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,213,74,.30), rgba(255,213,74,.06));
      border:1px solid rgba(255,213,74,.24);
      display:grid; place-items:center;
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .logo svg{ opacity:.95 }
    .title{ min-width:0; }
    .title h1{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title p{
      margin:3px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topRight{ display:flex; align-items:center; gap:10px; }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .pill b{ color:var(--text); font-weight:700; }
    .btnIcon{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .btnIcon:active{ transform: translateY(1px); }

    main{ padding:14px 14px 26px; }
    .grid{
      max-width:980px; margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .cardHeader p{ margin:4px 0 0; font-size:12px; color:var(--muted); }
    .cardBody{ padding:12px 14px 14px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .search{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1 1 320px;
      min-width:240px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: var(--btn);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ background: var(--btn2); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(255,213,74,.34);
      background: rgba(255,213,74,.10);
    }
    .btn.danger{
      border-color: rgba(255,59,59,.35);
      background: rgba(255,59,59,.10);
      color: #ffecec;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .item{
      display:grid;
      grid-template-columns: 66px 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .thumb{
      width:66px; height:66px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:6px;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.35));
    }
    .meta{ min-width:0; }
    .meta .name{
      font-size:14px;
      font-weight:700;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta .desc{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* + / - controls */
    .qtyBox{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .qtyBtn{
      width:42px;
      height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-size:18px;
      line-height:1;
      user-select:none;
    }
    .qtyBtn:active{ transform: translateY(1px); }
    .qtyVal{
      min-width:54px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--text);
      font-size:14px;
      text-align:center;
      user-select:none;
    }

    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:6px;
    }
    .badge.ok{ border-color: rgba(49,209,88,.35); background: rgba(49,209,88,.10); color:#dfffe8; }
    .badge.warn{ border-color: rgba(255,213,74,.35); background: rgba(255,213,74,.10); color:#fff4cf; }
    .badge.danger{ border-color: rgba(255,59,59,.35); background: rgba(255,59,59,.10); color:#ffe3e3; }

    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform: translateX(-50%);
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,24,.92);
      color:var(--text);
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:99;
      max-width: calc(100% - 18px);
      text-align:center;
      font-size:13px;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .sheet{
      position:fixed;
      inset:0;
      display:none;
      z-index:50;
    }
    .sheet.show{ display:block; }
    .sheet .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .sheet .panel{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(520px, calc(100% - 22px));
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(12,18,32,.98), rgba(8,12,22,.98));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet .panelHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sheet .panelHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .sheet .panelHeader button{
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:18px;
      cursor:pointer;
    }
    .sheet .panelBody{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .field input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .hint{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .panelActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      padding:14px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2c5.3 0 9.6 4.3 9.6 9.6S17.3 21.2 12 21.2 2.4 16.9 2.4 11.6 6.7 2 12 2Z" stroke="rgba(255,213,74,.9)" stroke-width="1.4"/>
            <path d="M7.2 12.4c1.4 2.2 3 3.2 4.8 3.2s3.4-1 4.8-3.2" stroke="rgba(255,213,74,.9)" stroke-width="1.4" stroke-linecap="round"/>
            <path d="M9.1 9.7h.01M14.9 9.7h.01" stroke="rgba(255,213,74,.9)" stroke-width="2.4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>Stock vÃ©hicule</h1>
          <p>SynchronisÃ© avec lâ€™outil interne â€” ApÃ©ro de Nuit 66</p>
        </div>
      </div>

      <div class="topRight">
        <div class="pill" id="syncPill" title="DerniÃ¨re synchronisation">
          <span>Sync</span> <b id="syncText">â€”</b>
        </div>
        <button class="btnIcon" id="btnOpenSettings" title="Outils">â˜°</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="cardHeader">
        <div>
          <h2>Stock en direct : synchronisÃ© avec le vÃ©hicule</h2>
          <p>Affichage indicatif (mise Ã  jour ~3 minutes). Un produit peut Ãªtre temporairement indisponible.</p>
        </div>
        <span class="badge ok" id="dirtyBadge">OK</span>
      </div>

      <div class="cardBody">
        <div class="toolbar">
          <div class="search">
            <span style="opacity:.7">ðŸ”Ž</span>
            <input id="q" type="search" placeholder="Rechercher un produitâ€¦" autocomplete="off" />
          </div>

          <div class="actions">
            <button class="btn" id="btnReload" title="Recharger depuis GitHub (public)">âŸ² Recharger</button>
            <button class="btn primary" id="btnSaveRepo" title="Publier via Cloudflare (PIN)">Publier</button>
            <button class="btn danger" id="btnReset" title="Annuler les modifications locales">Annuler</button>
          </div>
        </div>

        <div class="list" id="list"></div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- SETTINGS SHEET -->
<div class="sheet" id="sheet">
  <div class="backdrop" id="sheetBackdrop"></div>
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="panelHeader">
      <h3 id="settingsTitle">Outils</h3>
      <button id="sheetClose" aria-label="Fermer">âœ•</button>
    </div>

    <div class="panelBody">
      <div class="field">
        <label>Branch</label>
        <input id="ghBranch" value="main" readonly />
      </div>

      <div class="field">
        <label>Chemin du fichier</label>
        <input id="ghPath" value="apps/stock/stock/_snapshot.json" readonly />
      </div>

      <div class="field">
        <label>Code admin (PIN)</label>
        <input id="tokenInput" type="password" placeholder="0000" inputmode="numeric" />
      </div>

      <p class="hint" id="tokenHint">
        StockÃ© en local sur ce tÃ©lÃ©phone (6 mois).
        <span id="tokenState"></span>
      </p>
    </div>

    <div class="panelActions">
      <button class="btn" id="btnSaveToken">Enregistrer le code</button>
      <button class="btn danger" id="btnClearToken">Supprimer le code</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
   ========================= */

// IMPORTANT: images produits = ./stock/<id>.png  (car repo: /apps/stock/stock/<id>.png)
const IMG_DIR = "./stock/";

// Repo cible (info)
const DEFAULT_GH = {
  owner: "bullyto",
  repo: "outil",
  branch: "main",
  stockPath: "apps/stock/stock",
  ext: ".json"
};

// Cloudflare Worker (mÃªme Worker que stats)
const WORKER_BASE = "https://quiet-sunset-9161.apero-nuit-du-66.workers.dev";

// Seuil "faible"
const LOW_THRESHOLD = 3;

/* =========================
   PRODUITS (liste de base)
   - On remet TOUTES tes bouteilles de l'ancien index
   - Et en plus: si le snapshot contient d'autres IDs, on les affiche aussi automatiquement.
   ========================= */

const BASE_PRODUCTS = [
  { id:"poliakov", name:"Poliakov Vodka", price:29 },
  { id:"absolut", name:"Absolut Vodka", price:34 },
  { id:"ciroc_pomme", name:"CÃ®roc Pomme", price:49 },
  { id:"ciroc_classic", name:"CÃ®roc Classic", price:49 },
  { id:"ciroc_redberry", name:"CÃ®roc Red Berry", price:49 },

  { id:"william_peel", name:"William Peel", price:29 },
  { id:"label_5", name:"Label 5 Classic Black", price:32 },
  { id:"ballantines", name:"Ballantineâ€™s Finest", price:36 },
  { id:"jack_old7", name:"Jack Danielâ€™s Old No.7", price:40 },
  { id:"jack_honey", name:"Jack Danielâ€™s Tennessee Honey", price:42 },

  { id:"old_nick_darkwood", name:"Old Nick Dark Wood", price:29 },
  { id:"captain_morgan", name:"Captain Morgan Spiced Gold", price:34 },
  { id:"havana_especial", name:"Havana Club Especial", price:38 },

  { id:"old_nick_blanc", name:"Old Nick Rhum Blanc", price:27 },
  { id:"saint_james_blanc", name:"Saint James Rhum Blanc", price:32 },
  { id:"trois_rivieres", name:"Trois RiviÃ¨res Rhum Blanc", price:33 },
  { id:"havana_3ans", name:"Havana Club 3 ans", price:37 },

  { id:"gibsons_gin", name:"Gibsonâ€™s Gin", price:34 },
  { id:"gordons_gin", name:"Gordonâ€™s Gin", price:34 },

  { id:"ricard", name:"Ricard", price:35 },
  { id:"pastis_51", name:"Pastis 51", price:35 },

  { id:"get_27", name:"GET 27", price:32 },
  { id:"jagermeister", name:"JÃ¤germeister", price:35 },
  { id:"tequila_sanjose", name:"Tequila San JosÃ©", price:28 },

  { id:"xv_catalan_rose", name:"XV Catalan rose", price:19 },
  { id:"xv_catalan_blanc", name:"XV Catalan blanc", price:19 },
  { id:"xv_catalan_rouge", name:"XV Catalan rouge", price:19 },

  { id:"muscat", name:"Muscat", price:25 }
];

// Liste finale affichÃ©e (base + tout ce que le snapshot contient en plus)
let PRODUCTS = [...BASE_PRODUCTS];

/* =========================
   HELPERS
   ========================= */

function $(sel){ return document.querySelector(sel); }
function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

const listEl = $("#list");
const qEl = $("#q");
const btnReload = $("#btnReload");
const btnSaveRepo = $("#btnSaveRepo");
const btnReset = $("#btnReset");
const dirtyBadge = $("#dirtyBadge");
const syncText = $("#syncText");

// sheet
const sheet = $("#sheet");
const sheetBackdrop = $("#sheetBackdrop");
const sheetClose = $("#sheetClose");
const btnOpenSettings = $("#btnOpenSettings");
const tokenInput = $("#tokenInput");
const tokenState = $("#tokenState");
const btnSaveToken = $("#btnSaveToken");
const btnClearToken = $("#btnClearToken");

// local storage
const SETTINGS_KEY = "adn66_stock_settings_v3";

const state = {
  pin: "",
  stock: {},           // id -> qty
  dirty: new Set(),    // ids modified
  lastSync: null
};

function toastMsg(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toast);
  window.__toast = setTimeout(()=> t.classList.remove("show"), 2200);
}

function getGH(){
  return {
    owner: DEFAULT_GH.owner,
    repo: DEFAULT_GH.repo,
    branch: DEFAULT_GH.branch,
    stockPath: DEFAULT_GH.stockPath,
    ext: DEFAULT_GH.ext,
    pin: String(state.pin||"").trim()
  };
}

function snapshotPath(){
  const gh = getGH();
  return `${gh.stockPath}/_snapshot.json`;
}

function openSettings(){
  sheet.classList.add("show");
  tokenInput.value = state.pin || "";
  updateTokenHint();
}
function closeSettings(){
  sheet.classList.remove("show");
}

function updateTokenHint(){
  tokenState.textContent = state.pin ? "Code enregistrÃ© âœ…" : "";
}

function saveToken(pin){
  const exp = Date.now() + (1000 * 60 * 60 * 24 * 30 * 6); // ~6 mois
  localStorage.setItem(SETTINGS_KEY, JSON.stringify({ v: 3, pin: String(pin||"").trim(), exp }));
  state.pin = String(pin||"").trim();
  updateSaveButtonsState();
}

function clearToken(){
  localStorage.removeItem(SETTINGS_KEY);
  state.pin = "";
  updateSaveButtonsState();
}

function loadSettings(){
  const raw = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}");
  if (raw.exp && Date.now() > raw.exp) {
    localStorage.removeItem(SETTINGS_KEY);
  }
  state.pin = String(raw.pin ?? "").trim();
}

function updateSaveButtonsState(){
  const hasPin = !!String(getGH().pin||"").trim();
  btnSaveRepo.disabled = !hasPin;
}

function updateDirtyBadge(){
  const n = state.dirty.size;
  if(n === 0){
    dirtyBadge.textContent = "OK";
    dirtyBadge.className = "badge ok";
  }else{
    dirtyBadge.textContent = `${n} modif.`;
    dirtyBadge.className = "badge warn";
  }
}

function setSync(ts){
  state.lastSync = ts;
  syncText.textContent = ts ? new Date(ts).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}) : "â€”";
}

function clampQty(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return 0;
  return Math.max(0, Math.min(999, Math.round(n)));
}

function fmtNameFromId(id){
  // fallback propre si le snapshot contient un id pas dans BASE_PRODUCTS
  return String(id||"")
    .replace(/[_-]+/g, " ")
    .trim()
    .replace(/\b\w/g, c => c.toUpperCase());
}

function qtyTag(qty){
  if(qty === 0) return { cls:"danger", txt:"Rupture" };
  if(qty <= LOW_THRESHOLD) return { cls:"warn", txt:"Faible" };
  return { cls:"ok", txt:"OK" };
}

function adjustQty(id, delta){
  const cur = Number(state.stock[id] ?? 0);
  const nv = clampQty(cur + delta);
  state.stock[id] = nv;
  state.dirty.add(id);
  updateDirtyBadge();

  // update quick UI without full rerender (but keep safe)
  const row = listEl.querySelector(`.item[data-id="${CSS.escape(id)}"]`);
  if(row){
    const vEl = row.querySelector(".qtyVal");
    if(vEl) vEl.textContent = String(nv);
    const badge = row.querySelector(".badge");
    if(badge){
      const t = qtyTag(nv);
      badge.className = `badge ${t.cls}`;
      badge.innerHTML = `${t.txt}${state.dirty.has(id) ? " â€¢ modifiÃ©" : ""}`;
    }
  }

  toastMsg(delta > 0 ? "+1 ajoutÃ©" : "-1 retirÃ©");
}

function renderList(){
  const q = (qEl.value || "").trim().toLowerCase();

  const rows = PRODUCTS
    .filter(p => {
      if(!q) return true;
      const name = (p.name||"").toLowerCase();
      const id = (p.id||"").toLowerCase();
      return name.includes(q) || id.includes(q);
    })
    .map(p => {
      const id = p.id;
      const qty = Number(state.stock[id] ?? 0);
      const isDirty = state.dirty.has(id);
      const t = qtyTag(qty);
      const price = Number(p.price ?? 0);
      const imgSrc = IMG_DIR + id + ".png";

      return `
        <div class="item" data-id="${esc(id)}">
          <div class="thumb">
            <img src="${esc(imgSrc)}" alt="${esc(p.name)}" loading="lazy" onerror="this.style.display='none';" />
          </div>
          <div class="meta">
            <p class="name">${esc(p.name)}</p>
            <p class="desc">${price ? (esc(price) + "â‚¬") : "â€”"}</p>
            <span class="badge ${t.cls}">${t.txt}${isDirty ? " â€¢ modifiÃ©" : ""}</span>
          </div>
          <div class="qtyBox">
            <button class="qtyBtn minus" type="button" aria-label="Retirer 1">âˆ’</button>
            <div class="qtyVal" aria-label="QuantitÃ©">${esc(qty)}</div>
            <button class="qtyBtn plus" type="button" aria-label="Ajouter 1">+</button>
          </div>
        </div>
      `;
    })
    .join("");

  listEl.innerHTML = rows || `<div class="badge" style="padding:12px 14px;border-radius:16px;">Aucun rÃ©sultat</div>`;

  // bind +/-
  listEl.querySelectorAll(".item").forEach(el => {
    const id = el.getAttribute("data-id");
    const btnMinus = el.querySelector(".qtyBtn.minus");
    const btnPlus = el.querySelector(".qtyBtn.plus");
    if(btnMinus) btnMinus.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); adjustQty(id, -1); });
    if(btnPlus) btnPlus.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); adjustQty(id, +1); });
  });

  updateDirtyBadge();
}

/* =========================
   LOAD FROM REPO (public raw)
   - Charge le snapshot et:
     1) met Ã  jour state.stock
     2) ajoute automatiquement au catalogue tous les IDs prÃ©sents dans le snapshot
        (comme Ã§a tu as bien "tous les produits" mÃªme si la liste hardcodÃ©e est incomplÃ¨te)
   ========================= */

async function pullFromRepo(){
  const s = getGH();
  toastMsg("Chargement dÃ©pÃ´tâ€¦");

  const snapFile = snapshotPath();
  let snap = null;

  try{
    const rawUrl = `https://raw.githubusercontent.com/${s.owner}/${s.repo}/${s.branch}/${snapFile}?t=${Date.now()}`;
    const res = await fetch(rawUrl, { cache:"no-store" });
    if(res.ok) snap = await res.json();
  }catch(e){
    console.warn("pullFromRepo snapshot failed", e);
  }

  // snapshot attendu: { items:[ {id, qty, ...} ] }
  const snapshotIds = new Set();
  if(snap && Array.isArray(snap.items)){
    for(const it of snap.items){
      if(!it || !it.id) continue;
      const id = String(it.id);
      snapshotIds.add(id);
      if(typeof it.qty === "number") state.stock[id] = clampQty(it.qty);
    }
  }

  // Ajouter au catalogue tous les ids prÃ©sents dans le snapshot (si pas dÃ©jÃ  dans BASE_PRODUCTS)
  const known = new Set(PRODUCTS.map(p=>p.id));
  const extra = [];
  snapshotIds.forEach(id => {
    if(!known.has(id)){
      extra.push({ id, name: fmtNameFromId(id), price: 0 });
      known.add(id);
    }
  });

  // Rebuild PRODUCTS (base d'abord, extras ensuite)
  PRODUCTS = [...BASE_PRODUCTS, ...extra];

  updateStockUI();
  toastMsg("ChargÃ© âœ…");
}

function updateStockUI(){
  renderList();
  updateSaveButtonsState();
}

/* =========================
   PUBLISH VIA WORKER (PIN)
   ========================= */

async function pushToRepo(){
  const s = getGH();
  const pin = String(s.pin||"").trim();

  if(!pin){
    toastMsg("Entre le code admin (0000).");
    openSettings();
    return;
  }

  if(pin !== "0000"){
    toastMsg("Code invalide.");
    return;
  }

  toastMsg("Publication via Cloudflareâ€¦");

  const idsToPush = Object.keys(state.stock).filter(id => state.dirty.has(id));

  const payload = {
    pin,
    owner: s.owner,
    repo: s.repo,
    branch: s.branch,
    stockPath: s.stockPath,
    ext: s.ext,
    ids: idsToPush,
    stock: state.stock,
    updated_at: new Date().toISOString()
  };

  const r = await fetch(`${WORKER_BASE}/api/stock/publish`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const txt = await r.text();
  let j = null;
  try{ j = JSON.parse(txt); }catch(e){ j = null; }

  if(!r.ok || !j || j.ok !== true){
    const msg = (j && j.error) ? String(j.error) : `HTTP ${r.status}`;
    throw new Error(msg);
  }

  idsToPush.forEach(id => state.dirty.delete(id));
  updateStockUI();

  toastMsg("PubliÃ© âœ…");
}

/* =========================
   UI EVENTS
   ========================= */

btnOpenSettings.addEventListener("click", openSettings);
sheetBackdrop.addEventListener("click", closeSettings);
sheetClose.addEventListener("click", closeSettings);

btnSaveToken.addEventListener("click", ()=>{
  const pin = String(tokenInput.value||"").trim();
  if(!pin){ toastMsg("Code vide."); return; }
  saveToken(pin);
  updateTokenHint();
  toastMsg("Code enregistrÃ© âœ…");
});

btnClearToken.addEventListener("click", ()=>{
  clearToken();
  tokenInput.value = "";
  updateTokenHint();
  toastMsg("Code supprimÃ©.");
});

btnReload.addEventListener("click", async ()=>{
  try{
    await pullFromRepo();
    setSync(Date.now());
  }catch(e){
    console.error(e);
    toastMsg("Erreur rechargement.");
  }
});

btnSaveRepo.addEventListener("click", async ()=>{
  try{
    await pushToRepo();
    setSync(Date.now());
  }catch(e){
    console.error(e);
    toastMsg("Erreur : " + (e?.message || e));
  }
});

btnReset.addEventListener("click", ()=>{
  state.dirty.clear();
  pullFromRepo().then(()=>toastMsg("AnnulÃ© âœ…")).catch(()=>toastMsg("Erreur annulation."));
});

qEl.addEventListener("input", renderList);

/* =========================
   INIT
   ========================= */

(async function init(){
  loadSettings();
  updateTokenHint();
  updateSaveButtonsState();
  await pullFromRepo();
  setSync(Date.now());

  // SW
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
